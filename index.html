<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TFT Set 16 Team Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans JP', sans-serif; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Cost Colors */
        .cost-1 { border-color: #9ca3af; } /* Gray */
        .cost-2 { border-color: #22c55e; } /* Green */
        .cost-3 { border-color: #3b82f6; } /* Blue */
        .cost-4 { border-color: #a855f7; } /* Purple */
        .cost-5, .cost-7 { border-color: #eab308; } /* Gold */
        
        .trait-tier-0 { background-color: #334155; color: #94a3b8; } /* Inactive */
        .trait-tier-1 { background-color: #78350f; color: #fdba74; border: 1px solid #92400e; } /* Bronze */
        .trait-tier-2 { background-color: #374151; color: #e5e7eb; border: 1px solid #9ca3af; } /* Silver */
        .trait-tier-3 { background-color: #ca8a04; color: #fff; border: 1px solid #fde047; box-shadow: 0 0 10px rgba(234, 179, 8, 0.5); } /* Gold */
        .trait-tier-4 { background-color: #e879f9; color: #fff; background-image: linear-gradient(135deg, #a855f7, #ec4899); box-shadow: 0 0 15px rgba(236, 72, 153, 0.6); } /* Prismatic */

        .champ-card { transition: transform 0.1s; }
        .champ-card:active { transform: scale(0.95); }

        .tooltip {
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
        }
        .has-tooltip:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }
        .tooltip { z-index: 100; }

        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.7);
        }
        
        /* Tab Styles */
        .stage-tab {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        .stage-tab.active {
            background-color: #2563eb; /* blue-600 */
            color: white;
            border-color: #3b82f6;
        }
        .stage-tab:not(.active) {
            background-color: #1e293b; /* slate-800 */
            color: #94a3b8; /* slate-400 */
            border-color: #334155;
        }
        .stage-tab:not(.active):hover {
            background-color: #334155; /* slate-700 */
            color: #e2e8f0;
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-slate-800 border-b border-slate-700 p-4 sticky top-0 z-30 shadow-lg">
        <div class="container mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-teal-300">
                TFT Set 16 Team Planner
            </h1>
            <div class="flex flex-wrap gap-2 justify-center">
                <button id="btn-sort" onclick="app.sortTeam()" class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 rounded text-sm font-bold transition disabled:opacity-50 disabled:cursor-not-allowed">
                    コスト順
                </button>
                <button id="btn-reset" onclick="app.clearTeam()" class="bg-slate-600 hover:bg-slate-500 text-white px-3 py-1.5 rounded text-sm font-bold transition disabled:opacity-50 disabled:cursor-not-allowed">
                    リセット
                </button>
                <div class="w-px bg-slate-600 mx-1 hidden sm:block"></div>
                <button id="btn-save" onclick="app.openSaveModal()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-3 py-1.5 rounded text-sm font-bold transition disabled:opacity-50 disabled:cursor-not-allowed">
                    ガイド保存
                </button>
                <button id="btn-load" onclick="app.openLoadModal()" class="bg-emerald-700 hover:bg-emerald-600 text-white px-3 py-1.5 rounded text-sm font-bold transition disabled:opacity-50 disabled:cursor-not-allowed">
                    ガイド一覧
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto p-4 flex flex-col lg:flex-row gap-6">
        
        <!-- Left Column: Team & Traits -->
        <div class="lg:w-2/3 flex flex-col gap-6 order-2 lg:order-1">
            
            <!-- Stage Tabs Area -->
            <div class="flex items-center gap-2 overflow-x-auto pb-2 no-scrollbar" id="stage-tabs-container">
                <!-- Tabs injected by JS -->
            </div>

            <!-- Active Team Area -->
            <div class="bg-slate-800 rounded-xl border border-slate-700 p-4 shadow-xl">
                <div class="flex justify-between items-center mb-4 border-b border-slate-700 pb-2">
                    <h2 class="text-lg font-semibold text-slate-200 flex items-center gap-2">
                        現在のチーム <span id="team-count" class="text-sm text-slate-400 ml-2">(0/13)</span>
                    </h2>
                    <span id="data-source-indicator" class="text-xs text-slate-500 flex items-center gap-1">
                        <!-- Filled by JS -->
                    </span>
                </div>
                
                <!-- Team Grid -->
                <div id="team-grid" class="flex flex-wrap gap-4 min-h-[100px] items-center justify-center lg:justify-start bg-slate-900/50 p-4 rounded-lg border-2 border-dashed border-slate-700">
                    <p class="text-slate-500 text-sm select-none pointer-events-none">データの読み込みを待機しています...</p>
                </div>

                <!-- Transition Diff Area -->
                <div id="transition-diff" class="mt-4 hidden">
                    <div class="bg-slate-900/80 rounded-lg p-3 border border-slate-600">
                        <h3 class="text-xs font-bold text-slate-400 mb-2 uppercase tracking-wider flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" /></svg>
                            構成移行ガイド (前のステージとの差分)
                        </h3>
                        <div class="flex flex-col sm:flex-row gap-4">
                            <div class="flex-1 bg-emerald-900/20 p-2 rounded border border-emerald-900/50">
                                <span class="text-xs font-bold text-emerald-400 mb-1 block flex items-center gap-1">
                                    <span class="text-lg leading-none">+</span> 追加 (IN)
                                </span>
                                <div id="diff-in" class="flex flex-wrap gap-2 min-h-[32px] items-center"></div>
                            </div>
                            <div class="flex-1 bg-red-900/20 p-2 rounded border border-red-900/50">
                                <span class="text-xs font-bold text-red-400 mb-1 block flex items-center gap-1">
                                    <span class="text-lg leading-none">-</span> 削除 (OUT)
                                </span>
                                <div id="diff-out" class="flex flex-wrap gap-2 min-h-[32px] items-center"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Traits Panel -->
            <div class="bg-slate-800 rounded-xl border border-slate-700 p-4 shadow-xl">
                <h2 class="text-lg font-semibold text-slate-200 mb-4 border-b border-slate-700 pb-2">アクティブシナジー</h2>
                <div id="traits-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3">
                    <div class="col-span-full text-center text-slate-500 py-4">
                        ユニットを追加してシナジーを表示
                    </div>
                </div>
            </div>
            
        </div>

        <!-- Right Column: Unit Selector -->
        <div class="lg:w-1/3 order-1 lg:order-2">
            <div class="bg-slate-800 rounded-xl border border-slate-700 p-4 shadow-xl sticky top-24 max-h-[calc(100vh-8rem)] flex flex-col">
                
                <!-- Filters -->
                <div class="flex flex-col gap-3 mb-4">
                    <input type="text" id="search-input" placeholder="名前、特性、スキル..." 
                           class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm focus:outline-none focus:border-blue-500 transition" disabled>
                    
                    <div class="flex gap-2 overflow-x-auto pb-1 no-scrollbar">
                        <button onclick="app.filterCost('all')" class="filter-btn active bg-blue-600 text-white px-3 py-1 rounded text-xs whitespace-nowrap">All</button>
                        <button onclick="app.filterCost(1)" class="filter-btn bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded text-xs whitespace-nowrap border-b-2 border-gray-400">1 Cost</button>
                        <button onclick="app.filterCost(2)" class="filter-btn bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded text-xs whitespace-nowrap border-b-2 border-green-500">2 Cost</button>
                        <button onclick="app.filterCost(3)" class="filter-btn bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded text-xs whitespace-nowrap border-b-2 border-blue-500">3 Cost</button>
                        <button onclick="app.filterCost(4)" class="filter-btn bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded text-xs whitespace-nowrap border-b-2 border-purple-500">4 Cost</button>
                        <button onclick="app.filterCost(5)" class="filter-btn bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded text-xs whitespace-nowrap border-b-2 border-yellow-500">5+ Cost</button>
                    </div>
                </div>

                <!-- Champion Grid -->
                <div id="champion-pool" class="grid grid-cols-4 sm:grid-cols-5 gap-3 p-1 overflow-y-auto flex-grow content-start">
                    <div class="col-span-full flex flex-col items-center justify-center py-10 text-slate-400 gap-3">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                        <p>データを読み込んでいます...</p>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Modals -->
    
    <!-- Save Name Modal -->
    <div id="modal-save-name" class="fixed inset-0 z-[60] hidden modal-backdrop flex items-center justify-center p-4">
        <div class="bg-slate-800 rounded-xl border border-slate-700 shadow-2xl w-full max-w-sm p-6">
            <h3 class="text-lg font-bold text-white mb-4">ガイドを保存</h3>
            <p class="text-xs text-slate-400 mb-4">現在のすべてのステージ構成を保存します。<br>※ブラウザ内(LocalStorage)に保存されます。</p>
            <input type="text" id="save-team-name-input" class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-white mb-4 focus:border-blue-500 outline-none" placeholder="ガイド名を入力">
            <div class="flex justify-end gap-3">
                <button onclick="app.closeSaveModal()" class="text-slate-400 hover:text-white text-sm font-bold px-3 py-2">キャンセル</button>
                <button onclick="app.confirmSaveTeam()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded text-sm font-bold">保存</button>
            </div>
        </div>
    </div>

    <!-- Add Stage Name Modal -->
    <div id="modal-add-stage" class="fixed inset-0 z-[60] hidden modal-backdrop flex items-center justify-center p-4">
        <div class="bg-slate-800 rounded-xl border border-slate-700 shadow-2xl w-full max-w-sm p-6">
            <h3 class="text-lg font-bold text-white mb-4">新しいステージを追加</h3>
            <p class="text-xs text-slate-400 mb-4">現在の構成をコピーして新しいステージを作成します。</p>
            <input type="text" id="add-stage-name-input" class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-white mb-4 focus:border-blue-500 outline-none" placeholder="ステージ名を入力 (例: Lv8)">
            <div class="flex justify-end gap-3">
                <button onclick="app.closeAddStageModal()" class="text-slate-400 hover:text-white text-sm font-bold px-3 py-2">キャンセル</button>
                <button onclick="app.confirmAddStage()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded text-sm font-bold">追加</button>
            </div>
        </div>
    </div>

    <!-- Rename Stage Modal -->
    <div id="modal-rename-stage" class="fixed inset-0 z-[60] hidden modal-backdrop flex items-center justify-center p-4">
        <div class="bg-slate-800 rounded-xl border border-slate-700 shadow-2xl w-full max-w-sm p-6">
            <h3 class="text-lg font-bold text-white mb-4">ステージ名を変更</h3>
            <input type="text" id="rename-stage-input" class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-white mb-4 focus:border-blue-500 outline-none" placeholder="新しいステージ名">
            <div class="flex justify-end gap-3">
                <button onclick="app.closeRenameStageModal()" class="text-slate-400 hover:text-white text-sm font-bold px-3 py-2">キャンセル</button>
                <button onclick="app.confirmRenameStage()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded text-sm font-bold">変更</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal (Delete) -->
    <div id="modal-confirm" class="fixed inset-0 z-[80] hidden modal-backdrop flex items-center justify-center p-4">
        <div class="bg-slate-800 rounded-xl border border-slate-700 shadow-2xl w-full max-w-sm p-6 text-center">
            <h3 class="text-lg font-bold text-white mb-2">確認</h3>
            <p id="modal-confirm-text" class="text-slate-300 mb-6"></p>
            <div class="flex justify-center gap-4">
                <button onclick="app.closeConfirmModal()" class="bg-slate-600 hover:bg-slate-500 text-white px-4 py-2 rounded text-sm font-bold transition">キャンセル</button>
                <button onclick="app.executeDelete()" class="bg-red-600 hover:bg-red-500 text-white px-4 py-2 rounded text-sm font-bold transition">削除する</button>
            </div>
        </div>
    </div>

    <!-- Generic Message Modal -->
    <div id="modal-message" class="fixed inset-0 z-[70] hidden modal-backdrop flex items-center justify-center p-4">
        <div class="bg-slate-800 rounded-xl border border-slate-700 shadow-2xl w-full max-w-sm p-6 text-center">
            <p id="modal-message-text" class="text-slate-200 mb-6 font-bold"></p>
            <button onclick="document.getElementById('modal-message').classList.add('hidden')" class="bg-slate-600 hover:bg-slate-500 text-white px-4 py-2 rounded text-sm font-bold">OK</button>
        </div>
    </div>

    <!-- JSON View Modal -->
    <div id="modal-json-view" class="fixed inset-0 z-[90] hidden modal-backdrop flex items-center justify-center p-4">
        <div class="bg-slate-800 rounded-xl border border-slate-700 shadow-2xl w-full max-w-lg p-6 flex flex-col gap-4">
            <h3 class="text-lg font-bold text-white">ガイドデータ (JSON)</h3>
            <p class="text-xs text-slate-400">ユニットID、Slug、名前のみを含むJSONデータです。</p>
            <textarea id="json-output-area" class="w-full h-48 bg-slate-900 border border-slate-600 rounded p-3 text-xs text-slate-300 font-mono focus:outline-none focus:border-blue-500" readonly></textarea>
            <div class="flex justify-end gap-3">
                <button onclick="app.copyJsonToClipboard()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded text-sm font-bold transition">コピー</button>
                <button onclick="document.getElementById('modal-json-view').classList.add('hidden')" class="text-slate-400 hover:text-white text-sm font-bold px-3 py-2 transition">閉じる</button>
            </div>
        </div>
    </div>

    <!-- Load/Manage Teams Modal -->
    <div id="modal-saved-teams" class="fixed inset-0 z-50 hidden modal-backdrop flex items-center justify-center p-4">
        <div class="bg-slate-800 rounded-xl border border-slate-700 shadow-2xl w-full max-w-2xl max-h-[80vh] flex flex-col">
            <div class="p-4 border-b border-slate-700 flex justify-between items-center">
                <h3 class="text-xl font-bold text-white">保存済みガイド一覧</h3>
                <button onclick="app.closeLoadModal()" class="text-slate-400 hover:text-white transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <div class="flex-grow overflow-y-auto p-4">
                <div id="saved-teams-list" class="space-y-3">
                    <p class="text-slate-500 text-center py-4">読み込み中...</p>
                </div>
            </div>

            <div class="p-4 border-t border-slate-700 flex justify-between bg-slate-800/50 rounded-b-xl">
                <button onclick="app.confirmDeleteAll()" class="text-red-400 hover:text-red-300 text-sm font-semibold transition">
                    全データを削除
                </button>
                <button onclick="app.closeLoadModal()" class="bg-slate-600 hover:bg-slate-500 text-white px-4 py-2 rounded text-sm font-bold transition">
                    閉じる
                </button>
            </div>
        </div>
    </div>

    <!-- App Logic -->
    <script>
        // Constants & Configuration
        const CONFIG = {
            DATA_URL: "./data.json",
            NOTEBOOKS_URL: "./notebooks.json",
            IMAGE_BASE_URL: "/thumbs/",
            STORAGE_KEY: 'tft_planner_v3_local_data',
            MAX_TEAM_SIZE: 13,
        };

        // Utility Functions
        const Utils = {
            getUnitImage: (slug) => `${CONFIG.IMAGE_BASE_URL}${slug}.jpg`,
            
            getCostColorClass: (cost) => {
                const colors = {
                    1: 'text-gray-400',
                    2: 'text-green-400',
                    3: 'text-blue-400',
                    4: 'text-purple-400',
                    5: 'text-yellow-400',
                    7: 'text-yellow-400'
                };
                return colors[cost] || 'text-slate-200';
            },

            getCostBorderClass: (cost) => {
                const borders = {
                    1: 'border-gray-400',
                    2: 'border-green-400',
                    3: 'border-blue-400',
                    4: 'border-purple-400',
                    5: 'border-yellow-400',
                    7: 'border-yellow-400'
                };
                return borders[cost] || 'border-slate-500';
            },

            safeLower: (str) => (str || '').toString().toLowerCase(),
        };

        class TeamPlanner {
            constructor(unitsData, traitsData, notebooksData) {
                // Data
                this.unitsData = unitsData || [];
                this.traitsData = traitsData || [];
                
                // State
                this.savedGuides = [];
                this.currentGuide = {
                    name: "新しいガイド",
                    stages: [{ name: "初期構成", unitIds: [] }]
                };
                this.activeStageIndex = 0;
                this.filter = { cost: 'all', search: '' };
                this.pendingDelete = null;
                this.renameStageIndex = null;

                // Initialization
                this.toggleButtons(false);
                this.enableSearchInput();
                this.initData(notebooksData);
                this.renderAll();
                this.setupEventListeners();
            }

            get currentStage() {
                return this.currentGuide.stages[this.activeStageIndex];
            }

            // --- 1. Initialization & Data ---
            initData(notebooksData) {
                this.loadFromLocalStorage();
                if (this.savedGuides.length === 0 && notebooksData) {
                    this.importExternalNotebooks(notebooksData);
                }
                this.updateIndicator();
            }

            loadFromLocalStorage() {
                try {
                    const rawData = localStorage.getItem(CONFIG.STORAGE_KEY);
                    if (rawData) {
                        const data = JSON.parse(rawData);
                        if (Array.isArray(data.savedGuides) || Array.isArray(data.savedTeams)) {
                            this.savedGuides = data.savedGuides || data.savedTeams;
                        }
                        if (data.currentGuide) {
                            this.currentGuide = data.currentGuide;
                            this.activeStageIndex = data.activeStageIndex || 0;
                        }
                    }
                } catch (e) {
                    console.error("Local load failed:", e);
                }
            }

            saveToLocalStorage() {
                try {
                    const data = {
                        savedGuides: this.savedGuides,
                        currentGuide: this.currentGuide,
                        activeStageIndex: this.activeStageIndex,
                        lastUpdated: new Date().toISOString()
                    };
                    localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(data));
                } catch (e) {
                    console.error("Local save failed:", e);
                }
            }

            importExternalNotebooks(data) {
                let imported = [];
                if (Array.isArray(data)) {
                    imported = data.map((g, i) => this.parseGuideData(g, i));
                } else if (data.stages && Array.isArray(data.stages)) {
                    imported = [this.parseGuideData(data, 0)];
                } else {
                    imported = Object.keys(data).map((name, i) => {
                        const ids = this.mapUnitsToIds(data[name]);
                        return {
                            id: Date.now() + i,
                            name: name,
                            stages: [{ name: "Final Board", unitIds: ids }],
                            date: '外部データ'
                        };
                    });
                }
                
                if (imported.length > 0) {
                    this.savedGuides = [...this.savedGuides, ...imported];
                    this.saveToLocalStorage();
                }
            }

            parseGuideData(guide, index) {
                const stages = (guide.stages || []).map(s => ({
                    name: s.name || "Stage",
                    unitIds: this.mapUnitsToIds(s.units)
                }));
                if (stages.length === 0 && guide.units) {
                    stages.push({ name: "Main", unitIds: this.mapUnitsToIds(guide.units) });
                }
                return {
                    id: Date.now() + index,
                    name: guide.name || `Guide ${index + 1}`,
                    stages: stages,
                    date: '外部データ'
                };
            }

            mapUnitsToIds(units) {
                if (!Array.isArray(units)) return [];
                return units.map(u => (u && u.id) ? u.id : (typeof u === 'number' ? u : null))
                            .filter(id => id && this.getUnitById(id));
            }

            getUnitById(id) {
                return this.unitsData.find(u => u.id === id);
            }

            getUnitsFromIds(ids) {
                return ids.map(id => this.getUnitById(id)).filter(Boolean);
            }

            // --- 2. Stage Operations ---
            switchStage(index) {
                if (index < 0 || index >= this.currentGuide.stages.length) return;
                this.activeStageIndex = index;
                this.saveToLocalStorage();
                this.renderStages();
                this.renderTeam();
            }

            confirmAddStage() {
                const input = document.getElementById('add-stage-name-input');
                const name = input.value.trim() || `Lv${5 + this.currentGuide.stages.length}`;
                this.currentGuide.stages.push({
                    name: name,
                    unitIds: [...this.currentStage.unitIds] // Clone
                });
                this.activeStageIndex = this.currentGuide.stages.length - 1;
                this.saveToLocalStorage();
                this.renderAll();
                this.closeAddStageModal();
            }

            confirmRenameStage() {
                if (this.renameStageIndex === null) return;
                const input = document.getElementById('rename-stage-input');
                const name = input.value.trim();
                if (name) {
                    this.currentGuide.stages[this.renameStageIndex].name = name;
                    this.saveToLocalStorage();
                    this.renderStages();
                }
                this.closeRenameStageModal();
            }

            // --- 3. Team Operations ---
            addToTeam(id) {
                if (this.currentStage.unitIds.length >= CONFIG.MAX_TEAM_SIZE) return;
                this.currentStage.unitIds.push(id);
                this.saveToLocalStorage();
                this.renderTeam();
            }

            removeFromTeam(index) {
                this.currentStage.unitIds.splice(index, 1);
                this.saveToLocalStorage();
                this.renderTeam();
            }

            clearTeam() {
                this.currentStage.unitIds = [];
                this.saveToLocalStorage();
                this.renderTeam();
            }

            sortTeam() {
                const units = this.getUnitsFromIds(this.currentStage.unitIds);
                units.sort((a, b) => (a.cost !== b.cost) ? a.cost - b.cost : a.name.localeCompare(b.name));
                this.currentStage.unitIds = units.map(u => u.id);
                this.saveToLocalStorage();
                this.renderTeam();
            }

            // --- 4. Rendering ---
            renderAll() {
                this.renderChampionPool();
                this.renderStages();
                this.renderTeam();
            }

            renderStages() {
                const container = document.getElementById('stage-tabs-container');
                container.innerHTML = '';
                this.currentGuide.stages.forEach((stage, index) => {
                    const isActive = index === this.activeStageIndex;
                    const el = document.createElement('div');
                    el.className = `stage-tab px-4 py-1 rounded-full text-sm font-bold whitespace-nowrap transition border select-none ${isActive ? 'active' : ''}`;
                    el.onclick = () => this.switchStage(index);
                    el.innerHTML = `<span>${stage.name}</span>`;
                    
                    if (isActive) {
                        const editBtn = document.createElement('button');
                        editBtn.className = "ml-2 p-0.5 rounded hover:bg-white/20 text-white/70 hover:text-white transition";
                        editBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg>`;
                        editBtn.onclick = (e) => this.openRenameStageModal(index, e);
                        el.appendChild(editBtn);
                    }
                    container.appendChild(el);
                });
                
                const addBtn = document.createElement('button');
                addBtn.className = "px-3 py-1 rounded-full text-sm font-bold text-slate-400 border border-slate-600 hover:text-white hover:bg-slate-700 transition";
                addBtn.innerHTML = "+";
                addBtn.onclick = () => this.openAddStageModal();
                container.appendChild(addBtn);
            }

            renderChampionPool() {
                const pool = document.getElementById('champion-pool');
                pool.innerHTML = '';
                
                const term = Utils.safeLower(this.filter.search);
                const filtered = this.unitsData.filter(u => {
                    const costMatch = this.filter.cost === 'all' || 
                        (this.filter.cost === 5 && u.cost >= 5) || u.cost === this.filter.cost;
                    
                    const searchMatch = !term || 
                        Utils.safeLower(u.name).includes(term) || 
                        (u.synergies || []).some(t => Utils.safeLower(t).includes(term)) ||
                        Utils.safeLower(u.role).includes(term) ||
                        (u.ability && (Utils.safeLower(u.ability.name).includes(term) || Utils.safeLower(u.ability.description).includes(term)));
                    
                    return costMatch && searchMatch;
                });

                filtered.sort((a, b) => (a.cost !== b.cost) ? a.cost - b.cost : a.name.localeCompare(b.name));

                filtered.forEach(u => {
                    const el = document.createElement('div');
                    el.className = 'flex flex-col items-center cursor-pointer group relative w-full';
                    el.onclick = () => this.addToTeam(u.id);
                    el.innerHTML = `
                        <div class="w-full aspect-square rounded border-2 overflow-hidden champ-card cost-${u.cost} group-hover:brightness-110 relative">
                            <img src="${Utils.getUnitImage(u.slug)}" alt="${u.name}" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/80x80/1e293b/FFF?text=${u.name.charAt(0)}'">
                            <div class="absolute bottom-0 right-0 bg-slate-900/80 px-1 text-xs text-white font-bold">${u.cost}</div>
                        </div>
                        <span class="text-xs text-slate-400 mt-1 truncate w-full text-center group-hover:text-white">${u.name}</span>
                    `;
                    pool.appendChild(el);
                });
            }

            renderTeam() {
                const grid = document.getElementById('team-grid');
                const units = this.getUnitsFromIds(this.currentStage.unitIds);
                
                document.getElementById('team-count').textContent = `(${units.length}/${CONFIG.MAX_TEAM_SIZE})`;
                this.calculateTraits(units);
                this.renderDiff();
                
                grid.innerHTML = '';
                if (units.length === 0) {
                    grid.innerHTML = '<p class="text-slate-500 text-sm select-none pointer-events-none w-full text-center">下のリストからチャンピオンを選択してください</p>';
                    return;
                }

                units.forEach((u, idx) => {
                    const el = document.createElement('div');
                    el.className = 'relative cursor-pointer group has-tooltip';
                    el.onclick = () => this.removeFromTeam(idx);
                    el.innerHTML = `
                        <div class="relative w-16 h-16 md:w-20 md:h-20 rounded border-2 overflow-hidden champ-card cost-${u.cost}">
                            <img src="${Utils.getUnitImage(u.slug)}" alt="${u.name}" class="w-full h-full object-cover">
                            <div class="absolute inset-0 bg-red-500/0 hover:bg-red-500/40 flex items-center justify-center transition-colors">
                                <span class="text-white font-bold opacity-0 hover:opacity-100 text-2xl">×</span>
                            </div>
                        </div>
                        ${this.generateTooltip(u)}
                    `;
                    grid.appendChild(el);
                });
            }

            generateTooltip(u) {
                const costColor = Utils.getCostColorClass(u.cost);
                let info = '';
                if (u.ability) {
                    const mana = u.ability.mana ? `(${u.ability.mana.start}/${u.ability.mana.max})` : '';
                    info += `<div class="mb-2 border-t border-slate-600 pt-2"><p class="font-bold text-blue-400 text-xs mb-0.5">${u.ability.name} <span class="text-blue-300 text-[10px]">${mana}</span></p><p class="text-[10px] leading-tight text-slate-300 line-clamp-4">${u.ability.description}</p></div>`;
                }
                if (u.base_stats) {
                    const v = (val) => val && val.includes ? val.split('/')[0] : val;
                    info += `<div class="grid grid-cols-3 gap-1 text-[10px] text-slate-400 border-t border-slate-600 pt-2"><div>HP:${v(u.base_stats.health)}</div><div>AD:${v(u.base_stats.attack_damage)}</div><div>AS:${u.base_stats.attack_speed}</div></div>`;
                }
                return `<div class="tooltip absolute z-50 top-full left-1/2 transform -translate-x-1/2 mt-2 w-64 bg-slate-800 border border-slate-600 rounded-lg p-3 shadow-2xl pointer-events-none">
                    <div class="flex justify-between items-start mb-1"><h3 class="font-bold text-white text-sm">${u.name}</h3><span class="${costColor} font-bold text-xs">$${u.cost}</span></div>
                    <div class="flex flex-wrap gap-1 mb-2">${u.synergies.map(s => `<span class="bg-slate-700 px-1.5 py-0.5 rounded text-[10px] text-slate-300">${s}</span>`).join('')}</div>
                    ${info}
                </div>`;
            }

            renderDiff() {
                const diffDiv = document.getElementById('transition-diff');
                if (this.activeStageIndex === 0) {
                    diffDiv.classList.add('hidden');
                    return;
                }

                const prevIds = this.currentGuide.stages[this.activeStageIndex - 1].unitIds;
                const currIds = this.currentStage.unitIds;
                
                const countIds = (ids) => {
                    const c = {}; ids.forEach(id => c[id] = (c[id] || 0) + 1); return c;
                };
                const prevC = countIds(prevIds);
                const currC = countIds(currIds);
                const allIds = new Set([...prevIds, ...currIds]);
                
                const added = [], removed = [];
                allIds.forEach(id => {
                    const p = prevC[id] || 0;
                    const c = currC[id] || 0;
                    if (c > p) for(let i=0; i<c-p; i++) added.push(id);
                    else if (p > c) for(let i=0; i<p-c; i++) removed.push(id);
                });
                
                diffDiv.classList.remove('hidden');
                
                const render = (ids, containerId) => {
                    const el = document.getElementById(containerId);
                    el.innerHTML = ids.length ? '' : '<span class="text-[10px] text-slate-500">なし</span>';
                    ids.forEach(id => {
                        const u = this.getUnitById(id);
                        if(u) el.innerHTML += `<div class="relative w-8 h-8 rounded border ${Utils.getCostBorderClass(u.cost)} overflow-hidden" title="${u.name}"><img src="${Utils.getUnitImage(u.slug)}" class="w-full h-full object-cover"></div>`;
                    });
                };
                render(added, 'diff-in');
                render(removed, 'diff-out');
            }

            calculateTraits(units) {
                const container = document.getElementById('traits-container');
                container.innerHTML = '';
                
                const traitCounts = {};
                const seenSlugs = new Set();
                units.forEach(u => {
                    if (!seenSlugs.has(u.slug)) {
                        seenSlugs.add(u.slug);
                        u.synergies.forEach(t => traitCounts[t] = (traitCounts[t] || 0) + 1);
                    }
                });

                const activeTraits = Object.keys(traitCounts).map(name => {
                    const count = traitCounts[name];
                    const data = this.traitsData.find(t => t.name === name);
                    if (!data) return null;
                    
                    let tier = 0;
                    if (data.unique && count >= 1) tier = 3;
                    if (name === 'Targon' && count >= 1) tier = 3;
                    if (data.tiers) {
                        data.tiers.forEach((t, i) => {
                            if (count >= t.count) {
                                if (i === data.tiers.length - 1) tier = 4;
                                else if (i === 0) tier = 1;
                                else tier = 2;
                                if (tier === 2 && i >= 2) tier = 3;
                            }
                        });
                    }
                    return { name, count, tier, data };
                }).filter(Boolean);

                activeTraits.sort((a, b) => (b.tier - a.tier) || (b.count - a.count));
                
                if (activeTraits.length === 0) {
                     container.innerHTML = '<div class="col-span-full text-center text-slate-500 py-4">ユニットを追加してシナジーを表示</div>';
                     return;
                }

                activeTraits.forEach(t => {
                    let tiersHtml = '';
                    if (t.data.tiers) {
                        tiersHtml = '<div class="mt-2 border-t border-slate-600 pt-1 space-y-0.5">';
                        t.data.tiers.forEach(tier => {
                            const active = t.count >= tier.count ? 'text-white font-bold' : 'text-slate-500';
                            tiersHtml += `<div class="flex gap-2 text-xs ${active}"><span class="w-4 text-right">${tier.count}</span><span>${tier.bonus}</span></div>`;
                        });
                        tiersHtml += '</div>';
                    }

                    let styleClass = `trait-tier-${t.tier}`;
                    if (t.tier === 0) styleClass = 'bg-slate-700 text-slate-400 border border-slate-600';

                    const el = document.createElement('div');
                    el.className = `flex justify-between items-center p-2 px-3 rounded text-sm relative group has-tooltip cursor-help ${styleClass}`;
                    el.innerHTML = `<span class="font-bold truncate pr-2">${t.name}</span><span class="font-mono bg-black/20 px-2 rounded">${t.count}</span>
                        <div class="tooltip absolute z-50 top-full left-1/2 transform -translate-x-1/2 mt-2 w-64 bg-slate-800 border border-slate-600 rounded-lg p-3 shadow-2xl pointer-events-none text-left">
                            <h4 class="font-bold text-yellow-400 mb-1">${t.name}</h4><p class="text-xs text-slate-200">${t.data.effect}</p>${tiersHtml}
                        </div>`;
                    container.appendChild(el);
                });
            }

            // --- Event Handlers & UI Updates ---

            setupEventListeners() {
                const searchInput = document.getElementById('search-input');
                if (searchInput) searchInput.addEventListener('input', (e) => {
                    this.filter.search = e.target.value;
                    this.renderChampionPool();
                });
            }

            toggleButtons(disabled) {
                ['btn-sort', 'btn-reset', 'btn-save', 'btn-load'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.disabled = disabled;
                });
            }
            
            enableSearchInput() {
                const el = document.getElementById('search-input');
                if (el) el.disabled = false;
            }

            updateIndicator() {
                const el = document.getElementById('data-source-indicator');
                if (this.savedGuides.length > 0) {
                    el.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-500"></span> 準備完了';
                } else {
                    el.innerHTML = '<span class="w-2 h-2 rounded-full bg-blue-500"></span> 新規作成';
                }
            }

            // --- Guide Actions ---

            confirmSaveTeam() {
                const input = document.getElementById('save-team-name-input');
                const name = input.value.trim() || `ガイド ${this.savedGuides.length + 1}`;
                
                this.currentGuide.name = name;
                this.savedGuides.push({
                    id: Date.now(),
                    name: name,
                    stages: JSON.parse(JSON.stringify(this.currentGuide.stages)),
                    date: new Date().toLocaleString('ja-JP')
                });
                
                this.saveToLocalStorage();
                this.closeSaveModal();
                this.showMessage(`「${name}」を保存しました`);
            }

            applySavedTeam(index) {
                const saved = this.savedGuides[index];
                if (!saved) return;
                
                this.currentGuide = JSON.parse(JSON.stringify(saved));
                // Fix legacy format
                if (!this.currentGuide.stages && this.currentGuide.unitIds) {
                    this.currentGuide.stages = [{ name: "Main", unitIds: this.currentGuide.unitIds }];
                }
                
                this.activeStageIndex = 0;
                this.saveToLocalStorage();
                this.renderAll();
                this.closeLoadModal();
                this.showMessage(`「${saved.name}」を読み込みました`);
            }

            executeDelete() {
                if (!this.pendingDelete) return;
                
                if (this.pendingDelete.type === 'single') {
                    this.savedGuides.splice(this.pendingDelete.index, 1);
                } else {
                    this.savedGuides = [];
                }
                
                this.saveToLocalStorage();
                this.renderLoadModalList();
                this.closeConfirmModal();
            }

            // --- Modals ---
            openSaveModal() {
                document.getElementById('save-team-name-input').value = this.currentGuide.name;
                document.getElementById('modal-save-name').classList.remove('hidden');
            }
            closeSaveModal() { document.getElementById('modal-save-name').classList.add('hidden'); }
            
            openLoadModal() {
                document.getElementById('modal-saved-teams').classList.remove('hidden');
                this.renderLoadModalList();
            }
            closeLoadModal() { document.getElementById('modal-saved-teams').classList.add('hidden'); }

            openAddStageModal() {
                document.getElementById('add-stage-name-input').value = `Lv${5 + this.currentGuide.stages.length}`;
                document.getElementById('modal-add-stage').classList.remove('hidden');
            }
            closeAddStageModal() { document.getElementById('modal-add-stage').classList.add('hidden'); }

            openRenameStageModal(index, e) {
                if(e) e.stopPropagation();
                this.renameStageIndex = index;
                document.getElementById('rename-stage-input').value = this.currentGuide.stages[index].name;
                document.getElementById('modal-rename-stage').classList.remove('hidden');
            }
            closeRenameStageModal() { document.getElementById('modal-rename-stage').classList.add('hidden'); }

            openConfirmModal(msg) {
                document.getElementById('modal-confirm-text').innerText = msg;
                document.getElementById('modal-confirm').classList.remove('hidden');
            }
            closeConfirmModal() { 
                this.pendingDelete = null;
                document.getElementById('modal-confirm').classList.add('hidden'); 
            }

            showMessage(msg) {
                document.getElementById('modal-message-text').innerText = msg;
                document.getElementById('modal-message').classList.remove('hidden');
            }
            
            // --- Modal List Renderers ---

            renderLoadModalList() {
                const container = document.getElementById('saved-teams-list');
                container.innerHTML = '';
                if (this.savedGuides.length === 0) {
                    container.innerHTML = '<p class="text-slate-500 text-center py-8">保存されたガイドはありません。</p>';
                    return;
                }
                
                [...this.savedGuides].reverse().forEach((saved, revIdx) => {
                    const realIdx = this.savedGuides.length - 1 - revIdx;
                    const stages = saved.stages || (saved.unitIds ? [1] : []);
                    let units = [];
                    
                    if (saved.stages && saved.stages.length > 0) {
                        units = saved.stages[saved.stages.length - 1].unitIds;
                    } else if (saved.unitIds) {
                        units = saved.unitIds;
                    }
                    
                    const imgs = units.slice(0, 7).map(id => {
                        const u = this.getUnitById(id);
                        return u ? `<img src="${Utils.getUnitImage(u.slug)}" class="w-6 h-6 rounded-full border border-slate-500 object-cover" title="${u.name}">` : '';
                    }).join('');

                    const el = document.createElement('div');
                    el.className = 'bg-slate-700/50 rounded-lg p-3 flex flex-col sm:flex-row justify-between items-center gap-3 border border-slate-600 hover:border-slate-500 transition';
                    el.innerHTML = `
                        <div class="flex-grow w-full sm:w-auto">
                            <div class="flex items-baseline gap-2 mb-1">
                                <span class="font-bold text-white text-lg truncate">${saved.name}</span>
                                <span class="text-xs text-slate-400 whitespace-nowrap">${saved.date}</span>
                                <span class="text-xs bg-slate-600 px-1.5 rounded text-slate-300 ml-2">${stages.length} Stages</span>
                            </div>
                            <div class="flex gap-1 overflow-hidden">${imgs}${units.length > 7 ? `<span class="text-xs text-slate-500 flex items-center">+${units.length - 7}</span>` : ''}</div>
                        </div>
                        <div class="flex gap-2 w-full sm:w-auto justify-end">
                            <button onclick="app.applySavedTeam(${realIdx})" class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 rounded text-sm font-bold">読込</button>
                            <button onclick="app.viewTeamJson(${realIdx})" class="bg-slate-600 hover:bg-slate-500 text-white px-3 py-1.5 rounded text-sm font-bold">JSON</button>
                            <button onclick="app.confirmDeleteTeam(${realIdx})" class="bg-red-600/20 hover:bg-red-600/40 text-red-300 border border-red-800 px-3 py-1.5 rounded text-sm">削除</button>
                        </div>
                    `;
                    container.appendChild(el);
                });
            }

            confirmDeleteTeam(index) {
                this.pendingDelete = { type: 'single', index };
                this.openConfirmModal('このガイドを削除しますか？');
            }

            confirmDeleteAll() {
                if (this.savedGuides.length === 0) return;
                this.pendingDelete = { type: 'all' };
                this.openConfirmModal('全てのガイドを削除しますか？');
            }

            viewTeamJson(index) {
                const saved = this.savedGuides[index];
                if (!saved) return;
                
                let stages = saved.stages || [{ name: "Main", unitIds: saved.unitIds }];
                const exportData = {
                    name: saved.name,
                    stages: stages.map(st => ({
                        name: st.name,
                        units: st.unitIds.map(id => {
                            const u = this.getUnitById(id);
                            return u ? { id: u.id, slug: u.slug, name: u.name } : null;
                        }).filter(Boolean)
                    }))
                };
                
                document.getElementById('json-output-area').value = JSON.stringify(exportData, null, 2);
                document.getElementById('modal-json-view').classList.remove('hidden');
            }

            copyJsonToClipboard() {
                document.getElementById('json-output-area').select();
                document.execCommand('copy');
                this.showMessage('コピーしました');
                document.getElementById('modal-json-view').classList.add('hidden');
            }
        }

        async function initApp() {
            const poolEl = document.getElementById('champion-pool');
            try {
                const [resData, resNB] = await Promise.all([
                    fetch(CONFIG.DATA_URL),
                    fetch(CONFIG.NOTEBOOKS_URL)
                ]);
                
                if (!resData.ok) throw new Error("Data fetch failed");
                const tftData = await resData.json();
                
                let notebooks = null;
                if (resNB.ok) notebooks = await resNB.json();
                
                window.app = new TeamPlanner(tftData.unit, tftData.traits, notebooks);
                
            } catch (e) {
                console.error(e);
                poolEl.innerHTML = `<div class="col-span-full text-center text-red-500 py-10">読み込みエラー: ${e.message}</div>`;
            }
        }
        
        initApp();
    </script>
</body>
</html>